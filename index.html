<html>
  <head>
    <title> PeerConnection Explainer </title>
    <style>
      .textarea {
        text-align: left;
        padding: 5px;
        width: 90%;
        height: 5em;
        white-space: pre;
        overflow-wrap: normal;
        overflow: scroll;
        font-family:monospace;
        resize: both;
        border: 1px solid gray;
      }

      #parsed-local-description, #parsed-remote-description {
        background-color: lightgray;
      }

      .flex-container {
        text-align: center;
        display: flex;
      }

      .flex-container div { flex: 1; }
    </style>
  </head>

  <body>
    <div class="flex-container">
      <div>
        Local Description: <br />
        <div id="local-description" contenteditable="true" class="textarea" oninput="onTextAreaChange()"></div>
      </div>

      <div>
        Remote Description: <br />
        <div id="remote-description" contenteditable="true" class="textarea" oninput="onTextAreaChange()"></div>
      </div>
    </div>

    <hr />

    <h1> Results </h1>
    <div id="explain-results">
    </div>

    <hr />

    <div class="flex-container">
      <div>
        Parsed Local Description: <br />
        <div class="textarea" readonly id="parsed-local-description"></div>
      </div>

      <div>
        Parsed Remote Description: <br />
        <div class="textarea" readonly id="parsed-remote-description"></div>
      </div>
    </div>
  </body>

  <script src="wasm_exec.js"> </script>
  <script>
    function toggleSource(source) {
      JSON.parse(source).forEach(s => {
        document.getElementById(`${s.type}-${s.line}`).style.color = 'red';
      })
    }

    function renderOutput(output) {
      const el = document.getElementById('explain-results')
      el.innerHTML = ''

      for (const [key, value] of Object.entries(output)) {
        el.innerHTML += `<h2> ${key} </h2> <ul>`
        if (Array.isArray(value)) {
          value.forEach(v => {
            if (v.source.length !== 0) {
              el.innerHTML += `<li> <a href="#" onclick=toggleSource('${JSON.stringify(v.source)}'); event.preventDefault();> ${v.message} </a> </li>`
            } else {
              el.innerHTML += `<li> ${v.message} </li>`
            }
          })
        } else {

        }
        el.innerHTML += `</ul>`
      }
    }

    function renderDescription(desc, el, prefix) {
      el.innerHTML = ''

      desc.split("\n").forEach((line, i) => {
        el.innerHTML += `<div id="${prefix}-${i}" >${line}<div>`
      })

      el.style.height = '';
      el.style.height = el.scrollHeight + "px"
    }

    let wasm, memoryOffset
    let wasmMemory = () => {
      return new Uint8Array(wasm.exports.memory.buffer)
    }

    let parsedRemoteDescription = document.getElementById('parsed-remote-description')
    let parsedLocalDescription = document.getElementById('parsed-local-description')
    window.onTextAreaChange = () => {
      if (wasm === undefined) {
        return
      } else if (memoryOffset === undefined) {
        memoryOffset = wasm.exports.getWasmMemoryBufferOffset()
      }

      let remoteDescription = document.getElementById('remote-description').innerText
      let localDescription = document.getElementById('local-description').innerText

      wasmMemory().set((new TextEncoder().encode(remoteDescription)), memoryOffset)
      wasm.exports.SetRemoteDescription(remoteDescription.length)

      wasmMemory().set((new TextEncoder().encode(localDescription)), memoryOffset)
      wasm.exports.SetLocalDescription(localDescription.length)

      let explainResult = wasm.exports.Explain()
      renderOutput(JSON.parse(new TextDecoder().decode(wasmMemory().subarray(memoryOffset, memoryOffset + explainResult))))

      renderDescription(new TextDecoder().decode(wasmMemory().subarray(memoryOffset, memoryOffset + wasm.exports.GetLocalDescription())), parsedLocalDescription, 'local')
      renderDescription(new TextDecoder().decode(wasmMemory().subarray(memoryOffset, memoryOffset + wasm.exports.GetRemoteDescription())), parsedRemoteDescription, 'remote')
    }

    const go = new Go()
    fetch('wasm.wasm').then(resp =>
      resp.arrayBuffer()
    ).then(bytes =>
      WebAssembly.instantiate(bytes, go.importObject).then(function (obj) {
        wasm = obj.instance
        go.run(wasm)
      })
    )
  </script>
</html>
